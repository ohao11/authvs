# OIDCå®¢æˆ·ç«¯ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“¦ åŠŸèƒ½æ¦‚è¿°

OIDCå®¢æˆ·ç«¯ç®¡ç†åŠŸèƒ½æä¾›äº†å®Œæ•´çš„OAuth 2.0/OIDCå®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯çš„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ã€çŠ¶æ€ç®¡ç†å’Œå¯†é’¥é‡ç½®ç­‰åŠŸèƒ½ã€‚

## ğŸ—„ï¸ æ•°æ®åº“åˆå§‹åŒ–

è¿è¡Œ `rbac_init.sql` è„šæœ¬ï¼Œä¼šè‡ªåŠ¨åˆ›å»º `oauth_clients` è¡¨å¹¶åˆå§‹åŒ–4ä¸ªç¤ºä¾‹å®¢æˆ·ç«¯ï¼š

1. **web-portal** - Webé—¨æˆ·åº”ç”¨
2. **mobile-app** - ç§»åŠ¨åº”ç”¨
3. **spa-app** - å•é¡µåº”ç”¨  
4. **backend-service** - åç«¯æœåŠ¡

## ğŸ” æƒé™è¦æ±‚

æ‰€æœ‰æ¥å£éƒ½éœ€è¦ `CLIENT_LIST` æƒé™ï¼ˆæƒé™ID: 8ï¼‰ã€‚

## ğŸ“¡ APIæ¥å£åˆ—è¡¨

### 1. åˆ†é¡µæŸ¥è¯¢å®¢æˆ·ç«¯åˆ—è¡¨

```http
POST /api/admin/clients/page
Content-Type: application/json

{
  "clientName": "Web",        // å¯é€‰ï¼Œå®¢æˆ·ç«¯åç§°ï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰
  "clientId": "web",          // å¯é€‰ï¼Œå®¢æˆ·ç«¯IDï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰
  "clientType": 1,            // å¯é€‰ï¼Œå®¢æˆ·ç«¯ç±»å‹ï¼š1-Web 2-ç§»åŠ¨ 3-SPA 4-æœåŠ¡ç«¯
  "enabled": 1,               // å¯é€‰ï¼ŒçŠ¶æ€ï¼š0-ç¦ç”¨ 1-å¯ç”¨
  "pageNum": 1,               // é¡µç 
  "pageSize": 10              // æ¯é¡µå¤§å°
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "pageNum": 1,
    "pageSize": 10,
    "total": 4,
    "records": [
      {
        "id": 1,
        "clientId": "web-portal",
        "clientSecret": "$2a$****1Jm",  // è„±æ•æ˜¾ç¤º
        "clientName": "Webé—¨æˆ·åº”ç”¨",
        "grantTypes": ["authorization_code", "refresh_token"],
        "redirectUris": ["http://localhost:3000/callback"],
        "scopes": ["openid", "profile", "email"],
        "clientType": 1,
        "clientTypeDesc": "Webåº”ç”¨",
        "enabled": true,
        "createdAt": "2026-01-23T10:00:00"
      }
    ]
  }
}
```

### 2. æŸ¥è¯¢å®¢æˆ·ç«¯è¯¦æƒ…

```http
GET /api/admin/clients/{id}
```

**å“åº”ï¼š** è¿”å›å•ä¸ªå®¢æˆ·ç«¯å®Œæ•´ä¿¡æ¯ï¼ˆå¯†é’¥è„±æ•ï¼‰

### 3. åˆ›å»ºå®¢æˆ·ç«¯

```http
POST /api/admin/clients
Content-Type: application/json

{
  "clientName": "æ–°Webåº”ç”¨",                    // å¿…å¡«
  "clientType": 1,                             // å¿…å¡«ï¼Œ1-Web 2-ç§»åŠ¨ 3-SPA 4-æœåŠ¡ç«¯
  "grantTypes": "authorization_code,refresh_token",  // å¿…å¡«
  "redirectUris": "http://localhost:3000/callback",  // æ¡ä»¶å¿…å¡«
  "postLogoutRedirectUris": "http://localhost:3000",
  "accessTokenValidity": 3600,                 // Access Tokenæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  "refreshTokenValidity": 2592000,             // Refresh Tokenæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  "idTokenValidity": 3600,                     // ID Tokenæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  "scopes": "openid,profile,email",
  "autoApprove": false,                        // æ˜¯å¦è‡ªåŠ¨æˆæƒ
  "description": "æˆ‘çš„Webåº”ç”¨",
  "logoUrl": "https://example.com/logo.png",
  "homeUrl": "https://example.com"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸï¼Œè¯·å¦¥å–„ä¿å­˜client_secretï¼Œæ­¤å¯†é’¥ä»…æ˜¾ç¤ºä¸€æ¬¡",
  "data": {
    "id": 5,
    "clientId": "xin-a1b2c3d4",              // è‡ªåŠ¨ç”Ÿæˆ
    "clientSecret": "abc123def456...",        // âš ï¸ æ˜æ–‡å¯†é’¥ï¼Œä»…æ­¤ä¸€æ¬¡æ˜¾ç¤º
    "clientName": "æ–°Webåº”ç”¨",
    // ... å…¶ä»–å­—æ®µ
  }
}
```

âš ï¸ **é‡è¦æç¤ºï¼š** åˆ›å»ºæˆåŠŸåè¿”å›çš„ `clientSecret` æ˜¯æ˜æ–‡å¯†é’¥ï¼Œä»…æ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·åŠ¡å¿…å¦¥å–„ä¿å­˜ï¼

### 4. æ›´æ–°å®¢æˆ·ç«¯

```http
PUT /api/admin/clients/{id}
Content-Type: application/json

{
  "clientName": "æ›´æ–°åçš„åç§°",
  "clientType": 1,
  "grantTypes": "authorization_code,refresh_token",
  // ... å…¶ä»–å­—æ®µï¼ˆåŒåˆ›å»ºæ¥å£ï¼‰
}
```

**æ³¨æ„ï¼š** æ›´æ–°æ“ä½œä¸ä¼šä¿®æ”¹ `client_id` å’Œ `client_secret`ï¼Œå¯†é’¥éœ€è¦é€šè¿‡ä¸“é—¨çš„é‡ç½®æ¥å£ä¿®æ”¹ã€‚

### 5. åˆ é™¤å®¢æˆ·ç«¯

```http
DELETE /api/admin/clients/{id}
```

âš ï¸ **è­¦å‘Šï¼š** è¿™æ˜¯ç‰©ç†åˆ é™¤æ“ä½œï¼Œæ•°æ®å°†æ°¸ä¹…åˆ é™¤ï¼Œè¯·è°¨æ…æ“ä½œï¼

### 6. å¯ç”¨/ç¦ç”¨å®¢æˆ·ç«¯

```http
PATCH /api/admin/clients/{id}/status?enabled=true
```

**å‚æ•°ï¼š**
- `enabled`: `true` - å¯ç”¨ï¼Œ`false` - ç¦ç”¨

### 7. é‡ç½®å®¢æˆ·ç«¯å¯†é’¥

```http
POST /api/admin/clients/{id}/reset-secret
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "å¯†é’¥é‡ç½®æˆåŠŸï¼Œè¯·å¦¥å–„ä¿å­˜ï¼Œæ­¤å¯†é’¥ä»…æ˜¾ç¤ºä¸€æ¬¡",
  "data": {
    "clientId": "web-portal",
    "newClientSecret": "xyz789uvw456...",     // âš ï¸ æ–°å¯†é’¥æ˜æ–‡ï¼Œä»…æ­¤ä¸€æ¬¡æ˜¾ç¤º
    "message": "å¯†é’¥å·²é‡ç½®æˆåŠŸï¼Œè¯·å¦¥å–„ä¿å­˜ï¼Œæ­¤å¯†é’¥ä»…æ˜¾ç¤ºä¸€æ¬¡ï¼"
  }
}
```

âš ï¸ **é‡è¦æç¤ºï¼š** é‡ç½®åè¿”å›çš„æ–°å¯†é’¥æ˜¯æ˜æ–‡ï¼Œä»…æ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·åŠ¡å¿…å¦¥å–„ä¿å­˜ï¼

## ğŸ”§ å®¢æˆ·ç«¯ç±»å‹è¯´æ˜

| ç±»å‹å€¼ | ç±»å‹åç§° | é€‚ç”¨åœºæ™¯ | æ¨èæˆæƒç±»å‹ |
|-------|---------|---------|------------|
| 1 | Webåº”ç”¨ | ä¼ ç»ŸWebåº”ç”¨ï¼ˆåç«¯æ¸²æŸ“ï¼‰ | authorization_code, refresh_token |
| 2 | ç§»åŠ¨åº”ç”¨ | iOS/AndroidåŸç”Ÿåº”ç”¨ | authorization_code, refresh_token |
| 3 | å•é¡µåº”ç”¨ | Vue/React/Angular SPA | authorization_code (å»ºè®®é…åˆPKCE) |
| 4 | æœåŠ¡ç«¯åº”ç”¨ | åç«¯æœåŠ¡é—´è°ƒç”¨ | client_credentials |

## ğŸ“‹ æˆæƒç±»å‹è¯´æ˜

- **authorization_code**: æˆæƒç æ¨¡å¼ï¼ˆæœ€å®‰å…¨ï¼Œæ¨èï¼‰
- **refresh_token**: åˆ·æ–°ä»¤ç‰Œï¼ˆé…åˆæˆæƒç ä½¿ç”¨ï¼‰
- **client_credentials**: å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼ï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰
- **password**: å¯†ç æ¨¡å¼ï¼ˆä¸æ¨èï¼Œä»…ç‰¹æ®Šåœºæ™¯ï¼‰

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. å¯†é’¥åŠ å¯†å­˜å‚¨
- å®¢æˆ·ç«¯å¯†é’¥ä½¿ç”¨ BCrypt åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“
- åŠ å¯†å¼ºåº¦ä¸ç”¨æˆ·å¯†ç ç›¸åŒ

### 2. å¯†é’¥è„±æ•æ˜¾ç¤º
- åˆ—è¡¨å’Œè¯¦æƒ…æ¥å£ä¸­ï¼Œå¯†é’¥åªæ˜¾ç¤ºå‰4ä½å’Œå4ä½
- ç¤ºä¾‹ï¼š`$2a$****1Jm`

### 3. æ˜æ–‡å¯†é’¥ä»…æ˜¾ç¤ºä¸€æ¬¡
- åˆ›å»ºå®¢æˆ·ç«¯æ—¶è¿”å›æ˜æ–‡å¯†é’¥
- é‡ç½®å¯†é’¥æ—¶è¿”å›æ–°çš„æ˜æ–‡å¯†é’¥
- å…¶ä»–ä»»ä½•æ¥å£éƒ½ä¸ä¼šè¿”å›æ˜æ–‡å¯†é’¥

### 4. æ“ä½œå®¡è®¡
- æ‰€æœ‰æ“ä½œè‡ªåŠ¨è®°å½•åˆ° `operation_log` è¡¨
- åŒ…å«æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œè¯¦æƒ…ç­‰

## ğŸ“Š é»˜è®¤Tokenæœ‰æ•ˆæœŸ

| Tokenç±»å‹ | é»˜è®¤æœ‰æ•ˆæœŸ | ç§’æ•° |
|----------|-----------|-----|
| Access Token | 1å°æ—¶ | 3600 |
| Refresh Token | 30å¤© | 2592000 |
| ID Token | 1å°æ—¶ | 3600 |

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æ‰€æœ‰Webåº”ç”¨
```json
{
  "clientType": 1,
  "pageNum": 1,
  "pageSize": 10
}
```

### æŸ¥è¯¢å·²å¯ç”¨çš„å®¢æˆ·ç«¯
```json
{
  "enabled": 1,
  "pageNum": 1,
  "pageSize": 10
}
```

### æŒ‰åç§°æ¨¡ç³Šæœç´¢
```json
{
  "clientName": "é—¨æˆ·",
  "pageNum": 1,
  "pageSize": 10
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¯†é’¥ç®¡ç†**
   - åˆ›å»ºå’Œé‡ç½®å¯†é’¥æ—¶åŠ¡å¿…ä¿å­˜æ˜æ–‡å¯†é’¥
   - å¯†é’¥ä¸¢å¤±åæ— æ³•æ‰¾å›ï¼Œåªèƒ½é‡ç½®
   - é‡ç½®å¯†é’¥åï¼Œæ—§å¯†é’¥ç«‹å³å¤±æ•ˆ

2. **åˆ é™¤æ“ä½œ**
   - åˆ é™¤å®¢æˆ·ç«¯å‰è¯·ç¡®è®¤è¯¥å®¢æˆ·ç«¯ä¸å†ä½¿ç”¨
   - åˆ é™¤æ“ä½œä¸å¯æ¢å¤

3. **URIé…ç½®**
   - é‡å®šå‘URIå¿…é¡»ä¸å®é™…åº”ç”¨é…ç½®ä¸€è‡´
   - æ”¯æŒå¤šä¸ªURIï¼Œç”¨é€—å·åˆ†éš”
   - ä¸åŒ¹é…çš„URIä¼šå¯¼è‡´æˆæƒå¤±è´¥

4. **æƒé™è¦æ±‚**
   - æ‰€æœ‰æ“ä½œéœ€è¦ `CLIENT_LIST` æƒé™
   - å½“å‰æƒé™ç”±è§’è‰² `3-å®‰å…¨ç®¡ç†å‘˜` æ‹¥æœ‰

## ğŸ§ª æµ‹è¯•å»ºè®®

1. ä½¿ç”¨ `admin` æˆ– `secadmin` è´¦å·ç™»å½•ï¼ˆæ‹¥æœ‰å®¢æˆ·ç«¯ç®¡ç†æƒé™ï¼‰
2. å…ˆä½¿ç”¨æŸ¥è¯¢æ¥å£æŸ¥çœ‹ç¤ºä¾‹æ•°æ®
3. åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯ï¼Œä¿å­˜è¿”å›çš„å¯†é’¥
4. æµ‹è¯•æ›´æ–°ã€çŠ¶æ€åˆ‡æ¢ç­‰æ“ä½œ
5. æœ€åæµ‹è¯•å¯†é’¥é‡ç½®åŠŸèƒ½

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **æ•°æ®åº“è„šæœ¬**: `src/main/resources/rbac_init.sql`
- **å®ä½“ç±»**: `org.max.authvs.entity.OAuthClient`
- **Mapper**: `org.max.authvs.mapper.OAuthClientMapper`
- **Service**: `org.max.authvs.service.OAuthClientService`
- **Controller**: `org.max.authvs.api.OAuthClientController`
- **DTO**: `org.max.authvs.api.dto.client.*`

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚
